WITH Temp
AS
(
	SELECT YEAR(A.訂單日期) AS 訂單年,C.產品編號
		,SUM(B.數量) AS 銷售數量
		,SUM(ROUND(B.單價*B.數量*(1-折扣),0)) AS 營收
	FROM 訂貨主檔 AS A JOIN 訂貨明細 AS B ON A.訂單號碼=B.訂單號碼
		JOIN 產品資料 AS C ON B.產品編號=C.產品編號		
	GROUP BY YEAR(A.訂單日期),C.產品編號
)

SELECT E.產品編號,E.產品,G.類別名稱,E.單價,E.單位數量
	,F.銷售數量,F.營收,CONVERT(NVARCHAR,F.訂單年) AS 訂單年
FROM 產品資料 AS E JOIN Temp AS F ON E.產品編號=F.產品編號
	JOIN 產品類別 AS G ON E.類別編號=G.類別編號

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

SELECT DISTINCT CONVERT(NVARCHAR,YEAR(訂單日期)) AS 訂單年 FROM 訂貨主檔

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------